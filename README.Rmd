---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# SSEparser

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
[![CRAN status](https://www.r-pkg.org/badges/version/SSEparser)](https://CRAN.R-project.org/package=SSEparser)
[![R-CMD-check](https://github.com/calderonsamuel/SSEparser/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/calderonsamuel/SSEparser/actions/workflows/R-CMD-check.yaml)
[![Codecov test coverage](https://codecov.io/gh/calderonsamuel/SSEparser/branch/main/graph/badge.svg)](https://app.codecov.io/gh/calderonsamuel/SSEparser?branch=main)
<!-- badges: end -->

The goal of SSEparser is to provide robust functionality to parse Server-Sent Events and to build on top of it.

## Installation

You can install the development version of SSEparser like so:

``` r
pak::pak("calderonsamuel/SSEparser")
```

## Example

The `parse_sse()` function takes a string containing a server-sent event and converts it to a R list.

```{r example}
library(SSEparser)

event <- "data: test\nevent: message\nid: 123\n\n"

parse_sse(event)

```

Comments are usually received in a line starting with a colon. They are not parsed.

```{r}
with_comment <- "data: test\n: comment\nevent: example\n\n"

parse_sse(with_comment)
```

## Use in HTTP requests

`parse_sse()` wraps the `SSEparser` R6 class, which is also exported to be used with real-time streaming data. The following code handles a request with MIME type "text/event-stream".

```{r}
parser <- SSEparser$new()
httr2::request("https://postman-echo.com/server-events/5") %>%
	httr2::req_body_json(data = list(
		event = "message",
		request = "POST"
	)) %>%
	httr2::req_perform_stream(callback = \(x) {
		event <- rawToChar(x)
		parser$parse_sse(event)
		TRUE
	})

parser$events
```

## Extending SSEparser

Following the previous example, it should be useful to parse the content of every `data` field to be also an R list instead of a JSON string. For that, we can create a new R6 class which inherits from `SSEparser`.

```{r}
CustomParser <- R6::R6Class(
	classname = "CustomParser",
	inherit = SSEparser,
	public = list(
		
	)
)
```


